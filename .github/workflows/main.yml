name: Deploy NGINX Helm Chart with Quarkus Build

on:
  pull_request:
    branches:
    - main
    types: [opened, synchronize, reopened, closed]

env:
  configuration_item: 'nginx'

jobs:
  deploy:
    name: Deploy NGINX Helm Chart
    runs-on: ubuntu-latest
  # call-reusable-workflow:
    # uses: ./.github/workflows/actions/detect-changes.yml
    # uses: ./.github/actions/detect-changes/action.yml@feat/upgrade
    # with:
    #   GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #   COMMON_PATH: 'common'
    #   ENV_PATH: 'env'
    #   REPO_PATH: 'action-space'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: action-space

      - name: Set up Helm
        uses: azure/setup-helm@v4.2.0
        with:
          version: v3.14.4

      - name: Check for changed files
        uses: ././github/workflows/actions/detect-changes/action.yml
        # uses: buffdeveloper/nginx-actions/.github/workflows/actions/detect-changes.yml@dfeat/upgrade
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMON_PATH: 'common'
          ENV_PATH: 'env'
          REPO_PATH: 'action-space'

      - name: List files with changes
        run: |
          ls -l action-space/files_with_changes
          FILE_LIST=$(ls -1 action-space/files_with_changes)
          echo "file_list=$FILE_LIST" >> $GITHUB_OUTPUT
        shell: bash
      
      - name: Create KinD cluster
        uses: helm/kind-action@v1.10.0
      
      - name: Test cluster
        run: |
          kubectl cluster-info
          kubectl get nodes
          kubectl get pods --all-namespaces
        shell: bash

      # - name: Set up Helm
      #   run: |
      #     curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash
      #   shell: bash

      - name: Install NGINX Helm chart
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update
          helm install nginx-test-release bitnami/nginx -n action-space --create-namespace
        # Replace my-nginx-release and my-namespace with your desired values

      - name: Wait for NGINX deployment to be ready
        run: |
          kubectl wait --for=condition=Available deployment/nginx-test-release -n action-space
        # Replace my-nginx-release and my-namespace with the values you used in the Helm install step

